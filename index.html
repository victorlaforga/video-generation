<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kling AI Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        :root {
            --primary: #4a6bef;
            --primary-light: #6c8aff;
            --primary-dark: #3a50a9;
            --secondary: #ff6b6b;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--gray-700);
        }

        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-300);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .tab:hover:not(.active) {
            color: var(--primary-light);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .image-upload:hover {
            border-color: var(--primary-light);
            background-color: rgba(74, 107, 239, 0.05);
        }

        .image-upload input {
            display: none;
        }

        .image-upload-icon {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1rem;
        }

        .image-upload-text {
            font-size: 1rem;
            color: var(--gray-700);
        }

        .preview-image {
            max-width: 100%;
            max-height: 180px;
            display: none;
            margin-bottom: 1rem;
        }

        .button {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .button:hover {
            background-color: var(--primary-dark);
        }

        .button:disabled {
            background-color: var(--gray-300);
            cursor: not-allowed;
        }

        .slider-container {
            width: 100%;
            margin-bottom: 1rem;
        }

        .slider {
            width: 100%;
        }

        .slider-value {
            text-align: right;
            font-weight: 600;
            color: var(--primary);
        }

        .results-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .results-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--gray-800);
        }

        .results-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        .result-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .result-video {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            background: #000;
        }

        .result-info {
            padding: 1rem;
            background-color: white;
        }

        .result-prompt {
            font-size: 0.875rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .result-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

        .result-button {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-button:hover {
            background-color: var(--primary);
            color: white;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--gray-200);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--secondary);
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }

        .api-settings {
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .settings-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-toggle {
            font-size: 0.875rem;
            color: var(--primary);
            cursor: pointer;
        }

        .settings-content {
            display: none;
        }

        .settings-content.show {
            display: block;
        }

        .source-image-preview {
            max-width: 100%;
            max-height: 180px;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .source-image-container {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: var(--gray-100);
            border-radius: 4px;
        }
        
        .source-image-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }
        
        .result-info-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.75rem;
            color: var(--gray-700);
        }

        .task-status {
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .task-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .task-status.processing {
            background-color: #cce5ff;
            color: #004085;
        }

        .task-status.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .task-status.failed {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Kling AI Interface</div>
            <div class="subtitle">Create stunning AI-generated images and videos</div>
        </header>

        <div class="api-settings">
            <div class="settings-title">
                API Settings
                <span class="settings-toggle" id="settingsToggle">Show</span>
            </div>
            <div class="settings-content" id="settingsContent">
                <div class="form-group">
                    <label for="accessKey">Access Key</label>
                    <input type="text" id="accessKey" placeholder="Enter your Access Key">
                </div>
                <div class="form-group">
                    <label for="secretKey">Secret Key</label>
                    <input type="text" id="secretKey" placeholder="Enter your Secret Key">
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="image-generation">Image Generation</div>
            <div class="tab" data-tab="video-generation">Image to Video</div>
        </div>

        <div class="tab-content active" id="image-generation">
            <div class="grid-container">
                <div>
                    <div class="form-group">
                        <label for="imageUpload">Reference Image (Optional)</label>
                        <div class="image-upload" id="imageUploadContainer">
                            <input type="file" id="imageUpload" accept="image/*">
                            <div class="image-upload-icon">📷</div>
                            <div class="image-upload-text">Click to upload or drag and drop</div>
                        </div>
                        <img id="previewImage" class="preview-image">
                    </div>

                    <div class="form-group">
                        <label for="imagePrompt">Prompt</label>
                        <textarea id="imagePrompt" placeholder="Describe the image you want to generate..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="imageNegativePrompt">Negative Prompt (Optional)</label>
                        <textarea id="imageNegativePrompt" placeholder="Describe what you want to avoid in the image..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="imageReferenceStrength">Reference Strength: <span id="strengthValue">0.5</span></label>
                        <div class="slider-container">
                            <input type="range" min="0" max="1" step="0.01" value="0.5" class="slider" id="imageReferenceStrength">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="imageAspectRatio">Aspect Ratio</label>
                        <select id="imageAspectRatio">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="4:3">4:3 (Standard)</option>
                            <option value="16:9">16:9 (Widescreen)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="imageCount">Number of Images</label>
                        <select id="imageCount">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="4">4</option>
                        </select>
                    </div>

                    <button id="generateImageButton" class="button">Generate Images</button>
                </div>

                <div class="results-section">
                    <h2 class="results-title">Generated Images</h2>
                    <div class="results-container" id="imageResults">
                        <!-- Results will be displayed here -->
                    </div>
                    <div class="loading" id="imageLoading">
                        <div class="loading-spinner"></div>
                        <p>Generating images... This may take a few moments.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="video-generation">
            <div class="grid-container">
                <div>
                    <div class="form-group">
                        <label for="videoImageUpload">Source Image (Required)</label>
                        <div class="image-upload" id="videoImageUploadContainer">
                            <input type="file" id="videoImageUpload" accept="image/*">
                            <div class="image-upload-icon">📷</div>
                            <div class="image-upload-text">Click to upload or drag and drop</div>
                        </div>
                        <img id="videoPreviewImage" class="preview-image">
                    </div>

                    <div class="form-group">
                        <label for="videoPrompt">Prompt</label>
                        <textarea id="videoPrompt" placeholder="Describe how the image should animate..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="videoNegativePrompt">Negative Prompt (Optional)</label>
                        <textarea id="videoNegativePrompt" placeholder="Describe what you want to avoid in the video..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="videoMode">Generation Mode</label>
                        <select id="videoMode">
                            <option value="standard">Standard (Faster)</option>
                            <option value="professional">Professional (Higher Quality)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="videoModel">Model Version</label>
                        <select id="videoModel">
                            <option value="V1.0">Kling V1.0</option>
                            <option value="V1.5">Kling V1.5</option>
                            <option value="V1.6">Kling V1.6</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="videoDuration">Video Duration</label>
                        <select id="videoDuration">
                            <option value="5">5 seconds</option>
                            <option value="10">10 seconds</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="videoAspectRatio">Aspect Ratio</label>
                        <select id="videoAspectRatio">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="4:3">4:3 (Standard)</option>
                            <option value="16:9">16:9 (Widescreen)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                        </select>
                    </div>

                    <button id="generateVideoButton" class="button">Generate Video</button>
                </div>

                <div class="results-section">
                    <h2 class="results-title">Generated Videos</h2>
                    <div class="results-container" id="videoResults">
                        <!-- Results will be displayed here -->
                    </div>
                    <div class="loading" id="videoLoading">
                        <div class="loading-spinner"></div>
                        <p>Generating video... This may take a few minutes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global error handling for API requests
        function handleApiError(error, context) {
            console.error(`${context} error:`, error);
            
            let errorMessage = "An unexpected error occurred.";
            
            if (error.response) {
                // The request was made and the server responded with a status code
                // that falls out of the range of 2xx
                const status = error.response.status;
                const data = error.response.data;
                
                if (status === 401 || status === 403) {
                    errorMessage = "Authentication failed. Please check your API keys.";
                } else if (status === 400) {
                    errorMessage = `Bad request: ${data.message || "Please check your inputs"}`;
                } else if (status === 429) {
                    errorMessage = "Rate limit exceeded. Please try again later.";
                } else if (status >= 500) {
                    errorMessage = "Server error. Please try again later.";
                }
            } else if (error.request) {
                // The request was made but no response was received
                errorMessage = "No response from server. Please check your internet connection.";
            }
            
            // Display error to user
            alert(`${context}: ${errorMessage}`);
        }

        // Save API keys to localStorage
        function saveApiKeys() {
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            
            if (accessKey && secretKey) {
                localStorage.setItem('klingAccessKey', accessKey);
                localStorage.setItem('klingSecretKey', secretKey);
            }
        }

        // Load API keys from localStorage
        function loadApiKeys() {
            const accessKey = localStorage.getItem('klingAccessKey');
            const secretKey = localStorage.getItem('klingSecretKey');
            
            if (accessKey && secretKey) {
                document.getElementById('accessKey').value = accessKey;
                document.getElementById('secretKey').value = secretKey;
            }
        }
        
        // Tab Switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // API Settings Toggle
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsContent = document.getElementById('settingsContent');

        settingsToggle.addEventListener('click', () => {
            if (settingsContent.classList.contains('show')) {
                settingsContent.classList.remove('show');
                settingsToggle.textContent = 'Show';
            } else {
                settingsContent.classList.add('show');
                settingsToggle.textContent = 'Hide';
            }
        });

        // Image Upload Preview - Image Generation
        const imageUploadContainer = document.getElementById('imageUploadContainer');
        const imageUpload = document.getElementById('imageUpload');
        const previewImage = document.getElementById('previewImage');

        imageUploadContainer.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadContainer.style.borderColor = 'var(--primary)';
        });

        imageUploadContainer.addEventListener('dragleave', () => {
            imageUploadContainer.style.borderColor = 'var(--gray-300)';
        });

        imageUploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadContainer.style.borderColor = 'var(--gray-300)';
            
            if (e.dataTransfer.files.length) {
                imageUpload.files = e.dataTransfer.files;
                handleImageUpload(imageUpload.files[0], previewImage);
            }
        });

        imageUpload.addEventListener('change', () => {
            if (imageUpload.files.length) {
                handleImageUpload(imageUpload.files[0], previewImage);
            }
        });

        // Image Upload Preview - Video Generation
        const videoImageUploadContainer = document.getElementById('videoImageUploadContainer');
        const videoImageUpload = document.getElementById('videoImageUpload');
        const videoPreviewImage = document.getElementById('videoPreviewImage');

        videoImageUploadContainer.addEventListener('click', () => {
            videoImageUpload.click();
        });

        videoImageUploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            videoImageUploadContainer.style.borderColor = 'var(--primary)';
        });

        videoImageUploadContainer.addEventListener('dragleave', () => {
            videoImageUploadContainer.style.borderColor = 'var(--gray-300)';
        });

        videoImageUploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            videoImageUploadContainer.style.borderColor = 'var(--gray-300)';
            
            if (e.dataTransfer.files.length) {
                videoImageUpload.files = e.dataTransfer.files;
                handleImageUpload(videoImageUpload.files[0], videoPreviewImage);
            }
        });

        videoImageUpload.addEventListener('change', () => {
            if (videoImageUpload.files.length) {
                handleImageUpload(videoImageUpload.files[0], videoPreviewImage);
            }
        });

        function handleImageUpload(file, previewElement) {
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                previewElement.src = e.target.result;
                previewElement.style.display = 'block';
            };
            
            reader.readAsDataURL(file);
        }

        // Reference Strength Slider
        const strengthSlider = document.getElementById('imageReferenceStrength');
        const strengthValue = document.getElementById('strengthValue');

        strengthSlider.addEventListener('input', () => {
            strengthValue.textContent = strengthSlider.value;
        });

        // Image Generation Logic
        const generateImageButton = document.getElementById('generateImageButton');
        const imagePrompt = document.getElementById('imagePrompt');
        const imageNegativePrompt = document.getElementById('imageNegativePrompt');
        const imageReferenceStrength = document.getElementById('imageReferenceStrength');
        const imageAspectRatio = document.getElementById('imageAspectRatio');
        const imageCount = document.getElementById('imageCount');
        const imageResults = document.getElementById('imageResults');
        const imageLoading = document.getElementById('imageLoading');

        generateImageButton.addEventListener('click', async () => {
          console.log('Image generation button clicked');
          
          // Get access and secret keys
          const accessKey = document.getElementById('accessKey').value;
          const secretKey = document.getElementById('secretKey').value;
        
          if (!accessKey || !secretKey) {
            alert('Please enter your API credentials in the API Settings section');
            return;
          }
        
          // Save keys for future use
          saveApiKeys();
        
          if (!imagePrompt.value.trim()) {
            alert('Please enter a prompt');
            return;
          }
        
          // Show loading
          imageLoading.style.display = 'block';
          generateImageButton.disabled = true;
          imageResults.innerHTML = ''; // Clear previous results
        
          try {
            // Create simple JSON data for testing
            const requestData = {
              prompt: imagePrompt.value,
              negative_prompt: imageNegativePrompt.value || '',
              strength: imageReferenceStrength.value,
              aspect_ratio: imageAspectRatio.value,
              count: imageCount.value,
              access_key: accessKey,
              secret_key: secretKey,
              testing: true // Flag for testing
            };
        
            console.log('Sending image generation request...');
            console.log('Request data (without base64):', {...requestData, access_key: '***', secret_key: '***'});
            
            // First try without the image to test basic functionality
            const response = await fetch('/.netlify/functions/generate-image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(requestData)
            });
            
            console.log('Response status:', response.status);
            const responseText = await response.text();
            console.log('Response text:', responseText);
            
            let responseData;
            try {
              responseData = JSON.parse(responseText);
            } catch (e) {
              console.error('Failed to parse response as JSON:', e);
              throw new Error('Invalid response from server: ' + responseText);
            }
            
            if (!response.ok) {
              throw new Error(responseData.message || 'Failed to generate image');
            }
            
            console.log('Image generation task created:', responseData);
            
            // Mock success for testing
            alert('Task created with ID: ' + responseData.task_id);
            
            // Handle created task - normally we would poll here
            // await pollImageTaskStatus(taskId, accessKey, secretKey);
            
            // For now, just display some mock results
            displayImageResults([
              {id: 'mock1', url: 'https://picsum.photos/seed/test1/400/400'},
              {id: 'mock2', url: 'https://picsum.photos/seed/test2/400/400'}
            ], imagePrompt.value, imageNegativePrompt.value);
            
          } catch (error) {
            console.error('Image generation error:', error);
            alert('Image Generation Error: ' + error.message);
          } finally {
            // Hide loading
            imageLoading.style.display = 'none';
            generateImageButton.disabled = false;
          }
        });


        generateVideoButton.addEventListener('click', async () => {
  console.log('Video generation button clicked');
  
  // Get access and secret keys
  const accessKey = document.getElementById('accessKey').value;
  const secretKey = document.getElementById('secretKey').value;

  if (!accessKey || !secretKey) {
    alert('Please enter your API credentials in the API Settings section');
    return;
  }

  // Save keys for future use
  saveApiKeys();

  if (!videoImageUpload.files.length) {
    alert('Please upload a source image');
    return;
  }

  if (!videoPrompt.value.trim()) {
    alert('Please enter a prompt');
    return;
  }

  // Show loading
  videoLoading.style.display = 'block';
  generateVideoButton.disabled = true;
  videoResults.innerHTML = ''; // Clear previous results

  try {
    // Create simple JSON data for testing first (without image)
    const requestData = {
      prompt: videoPrompt.value,
      negative_prompt: videoNegativePrompt.value || '',
      mode: videoMode.value,
      model: videoModel.value,
      duration: videoDuration.value,
      aspect_ratio: videoAspectRatio.value,
      access_key: accessKey,
      secret_key: secretKey,
      testing: true // Flag for testing
    };

    console.log('Sending video generation request without image for testing...');
    console.log('Request data (without base64):', {...requestData, access_key: '***', secret_key: '***'});
    
    // First try without the image to test basic functionality
    const response = await fetch('/.netlify/functions/generate-video', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    });
    
    console.log('Response status:', response.status);
    const responseText = await response.text();
    console.log('Response text:', responseText);
    
    let responseData;
    try {
      responseData = JSON.parse(responseText);
    } catch (e) {
      console.error('Failed to parse response as JSON:', e);
      throw new Error('Invalid response from server: ' + responseText);
    }
    
    if (!response.ok) {
      throw new Error(responseData.message || 'Failed to generate video');
    }
    
    console.log('Video generation task created:', responseData);
    
    // Mock success for testing
    alert('Task created with ID: ' + responseData.task_id);
    
    // Mock results display
    displayVideoResults(
      {id: 'mock_vid', url: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'}, 
      videoPrompt.value, 
      videoNegativePrompt.value, 
      videoPreviewImage.src
    );
    
  } catch (error) {
    console.error('Video generation error:', error);
    alert('Video Generation Error: ' + error.message);
  } finally {
    // Hide loading
    videoLoading.style.display = 'none';
    generateVideoButton.disabled = false;
  }
});

        // Poll for image task completion
        async function pollImageTaskStatus(taskId, accessKey, secretKey) {
            try {
                // Create a status indicator
                const statusElement = document.createElement('div');
                statusElement.className = 'task-status pending';
                statusElement.textContent = 'Task created, waiting for processing...';
                imageResults.appendChild(statusElement);
                
                // Poll for status updates
                let isCompleted = false;
                let attempts = 0;
                const maxAttempts = 30; // 5 minutes (10 second intervals)
                
                while (!isCompleted && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds
                    
                    const queryParams = new URLSearchParams({
                        task_id: taskId,
                        access_key: accessKey,
                        secret_key: secretKey
                    });
                    
                    const response = await fetch(`/.netlify/functions/query-image-task?${queryParams}`);
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to query task status');
                    }
                    
                    const taskData = await response.json();
                    
                    // Update status display
                    if (taskData.status === 'completed') {
                        isCompleted = true;
                        statusElement.className = 'task-status completed';
                        statusElement.textContent = 'Task completed!';
                        
                        // Display the results
                        displayImageResults(taskData.results, imagePrompt.value, imageNegativePrompt.value);
                    } else if (taskData.status === 'failed') {
                        isCompleted = true;
                        statusElement.className = 'task-status failed';
                        statusElement.textContent = `Task failed: ${taskData.error || 'Unknown error'}`;
                    } else {
                        statusElement.className = 'task-status processing';
                        statusElement.textContent = `Task processing... (${Math.min(90, attempts * 3)}%)`;
                    }
                    
                    attempts++;
                }
                
                if (!isCompleted) {
                    statusElement.className = 'task-status failed';
                    statusElement.textContent = 'Task timed out. It may still complete, please check again later.';
                }
                
                // Scroll to results
                imageResults.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                handleApiError(error, 'Task Status Check');
            }
        }

        // Display Image Results
        function displayImageResults(images, prompt, negativePrompt) {
            // Remove any status indicator
            const statusElements = document.querySelectorAll('.task-status');
            statusElements.forEach(element => element.remove());
            
            images.forEach(image => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                resultCard.innerHTML = `
                    <img src="${image.url}" alt="Generated image" class="result-image">
                    <div class="result-info">
                        <div class="result-prompt">${prompt}</div>
                        ${negativePrompt ? `<div class="result-prompt negative">Negative: ${negativePrompt}</div>` : ''}
                        <div class="result-actions">
                            <button class="result-button download-image-button">Download</button>
                            <button class="result-button convert-button">Convert to Video</button>
                        </div>
                    </div>
                `;
                
                // Add click handler for the download button
                const downloadButton = resultCard.querySelector('.download-image-button');
                downloadButton.addEventListener('click', () => {
                    // Create a temporary anchor element and trigger download
                    const a = document.createElement('a');
                    a.href = image.url;
                    a.download = `kling_image_${image.id || new Date().getTime()}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                
                // Add click handler for convert to video button
                const convertButton = resultCard.querySelector('.convert-button');
                convertButton.addEventListener('click', () => {
                    // Switch to video tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    const videoTab = document.querySelector('.tab[data-tab="video-generation"]');
                    videoTab.classList.add('active');
                    
                    const videoContent = document.getElementById('video-generation');
                    videoContent.classList.add('active');
                    
                    // Create an Image object from the generated image URL
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = function() {
                        // Create a canvas to convert the image to a Blob
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        canvas.toBlob(blob => {
                            // Create a File object from the Blob
                            const file = new File([blob], 'generated-image.jpg', { type: 'image/jpeg' });
                            
                            // Create a DataTransfer object to set files
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            videoImageUpload.files = dataTransfer.files;
                            
                            // Set the preview image
                            videoPreviewImage.src = image.url;
                            videoPreviewImage.style.display = 'block';
                            
                            // Set the video prompt to match the image prompt
                            videoPrompt.value = prompt;
                            
                            // Scroll to the video generation section
                            videoContent.scrollIntoView({ behavior: 'smooth' });
                        }, 'image/jpeg');
                    };
                    
                    img.src = image.url;
                });
                
                imageResults.appendChild(resultCard);
            });
        }
        // Display Video Results function that was missing
function displayVideoResults(video, prompt, negativePrompt, sourceImageURL) {
  console.log('Displaying video results:', video);
  
  // Remove any status indicator
  const statusElements = document.querySelectorAll('.task-status');
  statusElements.forEach(element => element.remove());
  
  const resultCard = document.createElement('div');
  resultCard.className = 'result-card';
  
  // Add source image preview to show it was used in generation
  const sourceImagePreview = sourceImageURL ? 
      `<div class="source-image-container">
          <div class="source-image-label">Source Image Used:</div>
          <img src="${sourceImageURL}" alt="Source image" class="source-image-preview">
      </div>` : '';
  
  resultCard.innerHTML = `
      ${sourceImagePreview}
      <video src="${video.url}" controls class="result-video"></video>
      <div class="result-info">
          <div class="result-prompt">${prompt}</div>
          ${negativePrompt ? `<div class="result-prompt negative">Negative: ${negativePrompt}</div>` : ''}
          <div class="result-info-details">
              <div>Model: ${videoModel.value}</div>
              <div>Mode: ${videoMode.value}</div>
              <div>Duration: ${videoDuration.value}s</div>
          </div>
          <div class="result-actions">
              <button class="result-button download-button">Download</button>
          </div>
      </div>
  `;
  
  // Add click handler for the download button
  const downloadButton = resultCard.querySelector('.download-button');
  downloadButton.addEventListener('click', () => {
      // Create a temporary anchor element and trigger download
      const a = document.createElement('a');
      a.href = video.url;
      a.download = `kling_video_${video.id || new Date().getTime()}.mp4`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
  });
  
  videoResults.appendChild(resultCard);
}

// Similarly, let's also check if displayImageResults exists
function displayImageResults(images, prompt, negativePrompt) {
  console.log('Displaying image results:', images);
  
  // Remove any status indicator
  const statusElements = document.querySelectorAll('.task-status');
  statusElements.forEach(element => element.remove());
  
  images.forEach(image => {
      const resultCard = document.createElement('div');
      resultCard.className = 'result-card';
      
      resultCard.innerHTML = `
          <img src="${image.url}" alt="Generated image" class="result-image">
          <div class="result-info">
              <div class="result-prompt">${prompt}</div>
              ${negativePrompt ? `<div class="result-prompt negative">Negative: ${negativePrompt}</div>` : ''}
              <div class="result-actions">
                  <button class="result-button download-image-button">Download</button>
                  <button class="result-button convert-button">Convert to Video</button>
              </div>
          </div>
      `;
      
      // Add click handler for the download button
      const downloadButton = resultCard.querySelector('.download-image-button');
      downloadButton.addEventListener('click', () => {
          // Create a temporary anchor element and trigger download
          const a = document.createElement('a');
          a.href = image.url;
          a.download = `kling_image_${image.id || new Date().getTime()}.jpg`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
      });
      
      // Add click handler for convert to video button
      const convertButton = resultCard.querySelector('.convert-button');
      convertButton.addEventListener('click', () => {
          // Switch to video tab
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          
          const videoTab = document.querySelector('.tab[data-tab="video-generation"]');
          videoTab.classList.add('active');
          
          const videoContent = document.getElementById('video-generation');
          videoContent.classList.add('active');
          
          // Set preview image
          videoPreviewImage.src = image.url;
          videoPreviewImage.style.display = 'block';
          
          // Set the video prompt to match the image prompt
          videoPrompt.value = prompt;
          
          // Scroll to the video generation section
          videoContent.scrollIntoView({ behavior: 'smooth' });
      });
      
      imageResults.appendChild(resultCard);
  });
}
      </script>
      <button id="testFunction" style="background-color: green; color: white; padding: 10px; margin: 10px;">Test Netlify Function</button>

<script>
document.getElementById('testFunction').addEventListener('click', async () => {
  try {
    const response = await fetch('/.netlify/functions/test-function');
    const data = await response.json();
    console.log('Test function response:', data);
    alert('Test function works! See console for details.');
  } catch (error) {
    console.error('Test function error:', error);
    alert('Test function failed: ' + error.message);
  }
});
</script>